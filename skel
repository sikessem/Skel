#!/usr/bin/php --
<?php

require_once __DIR__ . '/cfg/_init.php';

if(!isset($argv[1])) {
  while('\q' !== ($line = readline('>')))
    parse_line($line);
} else {
  $input = $argv[1] ?? '';
  while(!is_readable($file = SRC_DIR . $input . SRC_EXT))
    $input = readline('Enter an existing file in the source directory : ');
  parse_file($file);
}

function parse_line(string $line) {
  $chars = str_split($line);
  $piece = '';
  foreach($chars as $char) {
    parse_piece($char, $piece);
  }
}

function parse_file(string $file) {
  $fh = @fopen($file, 'r');
  $piece = '';
  while(!feof($fh)) {
    $line = fgets($fh);
    parse_line($line, $piece);
  }
  fclose($fh);
}

function parse_piece(string $char, string &$piece) {
  if($char === ' ' || preg_match('/^[\r\n\t\s]$/', $char)) {
    $valid = false;
    if(in_array($piece, KEYWORDS)) $valid = true;
    else foreach(PATTERNS as $name => $pattern) {
      if(preg_match("/^$pattern$/", $piece)) {
        $valid = true;
        break;
      }
    }
    if($valid) {
      token($piece);
    } else {
      error($piece);
    }
    $piece = '';
    return;
  }
  $piece .= $char;
}

function token(string $token) {
  echo "Token: $token" . PHP_EOL;
}

function error(string $error) {
  fputs(STDERR, $error);
  exit(1);
}
